trigger:
 branches:
   include:
     - dev

stages:
  - stage: build_app_dev      
    displayName: Build Music app
    jobs:
      - job: run_py_app
        steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.x'
            addToPath: true
            architecture: 'x64'

        - script: |
              pip install -r requirements.txt
          displayName: Install Dependencies

        - task: CopyFiles@2
          inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)'
              Contents: |
                main.py
                requirements.txt
              TargetFolder: '$(Build.ArtifactStagingDirectory)/app'
        
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)/app'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
            replaceExistingArchive: true

        - script: |
             echo "===== Contents of app.zip ====="
             unzip -l $(Build.ArtifactStagingDirectory)/app.zip
          displayName: Inspect zip contents

        - task: AzureWebApp@1
          inputs:
            azureSubscription: 'azsvc'
            appType: 'webAppLinux'
            appName: 'musicappindia'
            package: '$(Build.ArtifactStagingDirectory)/*.zip'
            runtimeStack: 'PYTHON|3.13'
            startUpCommand: 'gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:$PORT'